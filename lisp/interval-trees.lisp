(in-package :arcimoog.symbolic-intervals)

;;; Interface to access symbols in this package from outside the package through keywords.

(defparameter *terminology* (make-hash-table))

(defun add-terminus (keyword-name symbol)
  (setf (gethash keyword-name *terminology*) symbol))

(defun dump-terminology ()
  (let ((result nil))
    (maphash (lambda (hash-key hash-value)
               (push (cons hash-key hash-value) result))
             *terminology*)
    result))

(defun lookup-terminus (keyword-name)
  ;; TODO handle non-existend entries.
  (if (keywordp keyword-name)
      (let ((result (gethash keyword-name *terminology*)))
        (if result
            result
            (error "Terminus ~a not in dictionary." keyword-name)))
      keyword-name))


(defun populate-terminology ()
  (add-terminus :maxima 'maxima)
  (add-terminus :longa 'longa)
  (add-terminus :brevis 'brevis)
  (add-terminus :semibrevis 'semibrevis)
  (add-terminus :minima 'minima)
  (add-terminus :semiminima 'semiminima)
  (add-terminus :fusa 'fusa)
  (add-terminus :croma 'fusa)
  (add-terminus :semifusa 'semifusa)
  (add-terminus :semicroma 'semifusa)
  (add-terminus :comma 'comma)
  (add-terminus :diesis 'diesis)
  (add-terminus :diesis-minore 'diesis-minore)
  (add-terminus :limma 'limma)
  (add-terminus :semitono-minore 'semitono-minore)
  (add-terminus :diesis-maggiore 'diesis-maggiore)
  (add-terminus :apotome 'apotome)
  (add-terminus :semitono-maggiore 'semitono-maggiore)
  (add-terminus :tono-minore 'tono-minore)
  (add-terminus :tono 'tono)
  (add-terminus :tono-naturale 'tono)
  (add-terminus :tono-accidentale 'tono)
  (add-terminus :tono-maggiore 'tono-maggiore)
  (add-terminus :terza-minima 'terza-minima)
  (add-terminus :terza-manca-di-minore 'terza-minima)
  (add-terminus :semiditono 'semiditono)
  (add-terminus :terza-minore 'terza-minore)
  (add-terminus :terza-più-di-minore 'terza-più-di-minore)
  (add-terminus :terza-minore-naturale 'terza-minore)
  (add-terminus :terza-minore-accidentale 'terza-minore)
  (add-terminus :terza-minore-propinqua 'terza-più-di-minore)
  (add-terminus :terza-manca-di-maggiore 'terza-più-di-minore)
  (add-terminus :ditono 'ditono)
  (add-terminus :terza-maggiore 'terza-maggiore)
  (add-terminus :terza-maggiore-naturale 'terza-maggiore)
  (add-terminus :terza-maggiore-accidentale 'terza-maggiore)
  (add-terminus :terza-più-di-maggiore 'terza-più-di-maggiore)
  (add-terminus :terza-maggiore-propinqua 'terza-più-di-maggiore)
  (add-terminus :quarta-minima 'quarta-minima)
  (add-terminus :diatessaron 'diatessaron)
  (add-terminus :quarta 'quarta)
  (add-terminus :quarta-naturale 'quarta)
  (add-terminus :quarta-accidentale 'quarta)
  (add-terminus :quarta-propinqua 'quarta-propinqua)
  (add-terminus :salto-della-più-di-quarta 'quarta-propinqua)
  (add-terminus :tritono 'tritono)
  (add-terminus :tritono-naturale 'tritono)
  (add-terminus :tritono-accidentale 'tritono)
  (add-terminus :quinta-imperfetta 'quinta-imperfetta)
  (add-terminus :quinta-imperfetta-naturale 'quinta-imperfetta)
  (add-terminus :quinta-imperfetta-accidentale 'quinta-imperfetta)
  (add-terminus :quinta-imperfetta-propinqua 'quinta-imperfetta-propinqua)
  (add-terminus :diapente 'diapente)
  (add-terminus :quinta 'quinta)
  (add-terminus :quinta-naturale 'quinta-naturale)
  (add-terminus :quinta-accidentale 'quinta-accidentale)
  (add-terminus :quinta-propinqua 'quinta-propinqua)
  (add-terminus :salto-della-più-di-quinta 'quinta-propinqua)
  (add-terminus :sesta-minima 'sesta-minima)
  (add-terminus :sesta-manca-di-minore 'sesta-minima)
  (add-terminus :sesta-minore 'sesta-minore)
  (add-terminus :sesta-minore-naturale 'sesta-minore)
  (add-terminus :sesta-minore-accidentale 'sesta-minore)
  (add-terminus :sesta-più-di-minore 'sesta-più-di-minore)
  (add-terminus :sesta-minore-propinqua 'sesta-più-di-minore)
  (add-terminus :sesta-manca-di-maggiore 'sesta-più-di-minore)
  (add-terminus :sesta-maggiore 'sesta-maggiore)
  (add-terminus :sesta-maggiore-naturale 'sesta-maggiore)
  (add-terminus :sesta-maggiore-accidentale 'sesta-maggiore)
  (add-terminus :sesta-più-di-maggiore 'sesta-più-di-maggiore)
  (add-terminus :sesta-maggiore-propinqua 'sesta-più-di-maggiore)
  (add-terminus :settima-minima 'settima-minima)
  (add-terminus :settima-minore 'settima-minore)
  (add-terminus :settima-minore-naturale 'settima-minore)
  (add-terminus :settima-minore-accidentale 'settima-minore)
  (add-terminus :settima-più-di-minore 'settima-più-di-minore)
  (add-terminus :settima-minore-propinqua 'settima-più-di-minore)
  (add-terminus :settima-manca-di-maggiore 'settima-più-di-minore)
  (add-terminus :settima-maggiore 'settima-maggiore)
  (add-terminus :settima-maggiore-naturale 'settima-maggiore)
  (add-terminus :settima-maggiore-accidentale 'settima-maggiore)
  (add-terminus :settima-più-di-maggiore 'settima-più-di-maggiore)
  (add-terminus :settima-maggiore-propinqua 'settima-più-di-maggiore)
  (add-terminus :ottava-minore 'ottava-minore)
  (add-terminus :ottava 'ottava)
  (add-terminus :ottava-naturale 'ottava)
  (add-terminus :ottava-accidentale 'ottava))

(populate-terminology)


;;; Definitions of interval trees

(defparameter *guido*
  '((tono . ((apotome . limma)))
    (semiditono . ((limma . tono)))
    (ditono . ((apotome . semiditono)
               (tono . tono)))
    (diatessaron . ((limma . ditono)
                    (tono . semiditono)))
    (tritono . ((apotome . diatessaron)
                (tono . ditono)))
    (semidiapente . ((limma . diatessaron)
                     (semiditono . semiditono)))
    (diapente . ((apotome . semidiapente)
                 (limma . tritono)
                 (tono . diatessaron)
                 (ditono . semiditono)))
    (sesta-minore . ((limma . diapente)
                     (tono . semidiapente)
                     (semiditono . diatessaron)))
    (sesta-maggiore . ((apotome . sesta-minore)
                       (tono . diapente)
                       (semiditono . tritono)
                       (ditono . diatessaron)))
    (settima-minore . ((limma . sesta-maggiore)
                       (tono . sesta-minore)
                       (semiditono . diapente)
                       (ditono . semidiapente)
                       (diatessaron . diatessaron)))
    (settima-maggiore . ((apotome . settima-minore)
                         (tono . sesta-maggiore)
                         (ditono . diapente)
                         (diatessaron . tritono)))
    (diapason . ((limma . settima-maggiore)
                 (tono . settima-minore)
                 (semiditono . sesta-maggiore)
                 (ditono . sesta-minore)
                 (diatessaron . diapente)
                 (tritono . semidiapente)))))

(defparameter *musica-mista*
  '((ottava . ((quinta . quarta)
               (quinta-imperfetta . tritono)
               (sesta-minore . terza-maggiore)
               (sesta-maggiore . terza-minore)
               (settima-minore . tono)
               (settima-maggiore . semitono-maggiore)))
    (settima-maggiore . ((quinta . terza-maggiore)
                         (quarta . tritono)
                         (sesta-maggiore . tono)
                         (settima-minore . semitono-minore)))
    (settima-minore . ((quinta . terza-minore)
                       (quarta . quarta)
                       (terza-maggiore . quinta-imperfetta)))
    (sesta-maggiore . ((quarta . terza-maggiore)
                       (tritono . terza-minore)
                       (quinta . tono)))
    (sesta-minore . ((quarta . terza-minore)
                     (quinta . semitono-maggiore)))
    (quinta . ((terza-maggiore . terza-minore)
               (quarta . tono)
               (tritono . semitono-maggiore)))
    (quinta-imperfetta . ((terza-minore . terza-minore)
                          (quarta . semitono-maggiore)))
    (tritono . ((terza-maggiore . tono)
                (quarta . semitono-minore)))
    (quarta . ((terza-maggiore . semitono-maggiore)
               (terza-minore . tono)))
    (terza-maggiore . ((tono . tono)
                       (terza-minore . semitono-minore)))
    (terza-minore . ((tono . semitono-maggiore)))
    (tono . ((semitono-maggiore . semitono-minore)))))

(defparameter *vicentino-diatonico*
  '((ottava . ((settima-maggiore . semitono-maggiore)
               (settima-minore . tono)
               (sesta-maggiore . terza-minore)
               (sesta-minore . terza-maggiore)
               (quinta . quarta)
               (quinta-imperfetta . tritono)))
    (settima-maggiore . ((sesta-maggiore . tono)
                         (quinta . terza-maggiore)
                         (tritono . quarta)))
    (settima-minore . ((sesta-maggiore . semitono-maggiore)
                       (sesta-minore . tono)
                       (quinta . terza-minore)
                       (quinta-imperfetta . terza-maggiore)
                       (quarta . quarta)))
    (sesta-maggiore . ((quinta . tono)
                       (tritono . terza-minore)
                       (quarta . terza-maggiore)))
    (sesta-minore . ((quinta . semitono-maggiore)
                     (quinta-imperfetta . tono)
                     (quarta . terza-minore)))
    (quinta . ((tritono . semitono-maggiore)
               (quarta . tono)
               (terza-maggiore . terza-minore)))
    (quinta-imperfetta . ((quarta . semitono-maggiore)
                          (terza-minore . terza-minore)))
    (tritono . ((terza-maggiore . tono)))
    (quarta . ((terza-maggiore . semitono-maggiore)
               (terza-minore . tono)))
    (terza-maggiore . ((tono . tono)))
    (terza-minore . ((tono . semitono-maggiore)))))

(defparameter *vicentino-cromatico*
  '((ottava . ((settima-maggiore . semitono-maggiore)
               (settima-minore . tono)
               (sesta-maggiore . terza-minore)
               (sesta-minore . terza-maggiore)
               (quinta . quarta)
               (quinta-imperfetta . tritono)))
    (settima-maggiore . ((settima-minore . semitono-minore)
                         (sesta-maggiore . tono)
                         (quinta . terza-maggiore)
                         (tritono . quarta)))
    (settima-minore . ((sesta-maggiore . semitono-maggiore)
                       (sesta-minore . tono)
                       (quinta . terza-minore)
                       (quinta-imperfetta . terza-maggiore)
                       (quarta . quarta)))
    (sesta-maggiore . ((sesta-minore . semitono-minore)
                       (quinta . tono)
                       (tritono . terza-minore)
                       (quarta . terza-maggiore)))
    (sesta-minore . ((quinta . semitono-maggiore)
                     (quinta-imperfetta . tono)
                     (quarta . terza-minore)))
    (quinta . ((quinta-imperfetta . semitono-minore)
               (tritono . semitono-maggiore)
               (quarta . tono)
               (terza-maggiore . terza-minore)))
    (quinta-imperfetta . ((quarta . semitono-maggiore)
                          (terza-minore . terza-minore)))
    (tritono . ((quarta . semitono-minore)
                (terza-maggiore . tono)))
    (quarta . ((terza-maggiore . semitono-maggiore)
               (terza-minore . tono)))
    (terza-maggiore . ((terza-minore . semitono-minore)
                       (tono . tono)))
    (terza-minore . ((tono . semitono-maggiore)))
    (tono . ((semitono-maggiore . semitono-minore)))
    (semitono-maggiore . ((semitono-minore . diesis-minore)))))

(defparameter *vicentino-enarmonico*
  '((ottava . ((ottava-minore . diesis-minore)
               (settima-più-di-maggiore . semitono-minore)
               (settima-maggiore . semitono-maggiore)
               (settima-più-di-minore . tono-minore)
               (settima-minore . tono)
               (settima-minima . tono-maggiore)
               (sesta-più-di-maggiore . terza-minima)
               (sesta-maggiore . terza-minore)
               (sesta-più-di-minore . terza-più-di-minore)
               (sesta-minore . terza-maggiore)
               (sesta-minima . terza-più-di-maggiore)
               (quinta-propinqua . quarta-minima)
               (quinta . quarta)
               (quinta-imperfetta-propinqua . quarta-propinqua)
               (quinta-imperfetta . tritono)))
    (ottava-minore . ((settima-più-di-maggiore . diesis-minore)
                      (settima-maggiore . semitono-minore)
                      (settima-più-di-minore . semitono-maggiore)
                      (settima-minore . tono-minore)
                      (settima-minima . tono)
                      (sesta-più-di-maggiore . tono-maggiore)
                      (sesta-maggiore . terza-minima)
                      (sesta-più-di-minore . terza-minore)
                      (sesta-minore . terza-più-di-minore)
                      (sesta-minima . terza-maggiore)
                      (quinta-propinqua . terza-più-di-maggiore)
                      (quinta . quarta-minima)
                      (quinta-imperfetta-propinqua . quarta)
                      (quinta-imperfetta . quarta-propinqua)
                      (tritono . tritono)))
    (settima-più-di-maggiore . ((settima-maggiore . diesis-minore)
                                (settima-più-di-minore . semitono-minore)
                                (settima-minore . semitono-maggiore)
                                (settima-minima . tono-minore)
                                (sesta-più-di-maggiore . tono)
                                (sesta-maggiore . tono-maggiore)
                                (sesta-più-di-minore . terza-minima)
                                (sesta-minore . terza-minore)
                                (sesta-minima . terza-più-di-minore)
                                (quinta-propinqua . terza-maggiore)
                                (quinta . terza-più-di-maggiore)
                                (quinta-imperfetta-propinqua . quarta-minima)
                                (quinta-imperfetta . quarta)
                                (tritono . quarta-propinqua)))
    (settima-maggiore . ((settima-più-di-minore . diesis-minore)
                         (settima-minore . semitono-minore)
                         (settima-minima . semitono-maggiore)
                         (sesta-più-di-maggiore . tono-minore)
                         (sesta-maggiore . tono)
                         (sesta-più-di-minore . tono-maggiore)
                         (sesta-minore . terza-minima)
                         (sesta-minima . terza-minore)
                         (quinta-propinqua . terza-più-di-minore)
                         (quinta . terza-maggiore)
                         (quinta-imperfetta-propinqua . terza-più-di-maggiore)
                         (quinta-imperfetta . quarta-minima)
                         (tritono . quarta)
                         (quarta-propinqua . quarta-propinqua)))
    (settima-più-di-minore . ((settima-minore . diesis-minore)
                              (settima-minima . semitono-minore)
                              (sesta-più-di-maggiore . semitono-maggiore)
                              (sesta-maggiore . tono-minore)
                              (sesta-più-di-minore . tono)
                              (sesta-minore . tono-maggiore)
                              (sesta-minima . terza-minima)
                              (quinta-propinqua . terza-minore)
                              (quinta . terza-più-di-minore)
                              (quinta-imperfetta-propinqua . terza-maggiore)
                              (quinta-imperfetta . terza-più-di-maggiore)
                              (tritono . quarta-minima)
                              (quarta-propinqua . quarta)))
    (settima-minore . ((settima-minima . diesis-minore)
                       (sesta-più-di-maggiore . semitono-minore)
                       (sesta-maggiore . semitono-maggiore)
                       (sesta-più-di-minore . tono-minore)
                       (sesta-minore . tono)
                       (sesta-minima . tono-maggiore)
                       (quinta-propinqua . terza-minima)
                       (quinta . terza-minore)
                       (quinta-imperfetta-propinqua . terza-più-di-minore)
                       (quinta-imperfetta . terza-maggiore)
                       (tritono . terza-più-di-maggiore)
                       (quarta-propinqua . quarta-minima)
                       (quarta . quarta)))
    (settima-minima . ((sesta-più-di-maggiore . diesis-minore)
                       (sesta-maggiore . semitono-minore)
                       (sesta-più-di-minore . semitono-maggiore)
                       (sesta-minore . tono-minore)
                       (sesta-minima . tono)
                       (quinta-propinqua . tono-maggiore)
                       (quinta . terza-minima)
                       (quinta-imperfetta-propinqua . terza-minore)
                       (quinta-imperfetta . terza-più-di-minore)
                       (tritono . terza-maggiore)
                       (quarta-propinqua . terza-più-di-maggiore)
                       (quarta . quarta-minima)))
    (sesta-più-di-maggiore . ((sesta-maggiore . diesis-minore)
                              (sesta-più-di-minore . semitono-minore)
                              (sesta-minore . semitono-maggiore)
                              (sesta-minima . tono-minore)
                              (quinta-propinqua . tono)
                              (quinta . tono-maggiore)
                              (quinta-imperfetta-propinqua . terza-minima)
                              (quinta-imperfetta . terza-minore)
                              (tritono . terza-più-di-minore)
                              (quarta-propinqua . terza-maggiore)
                              (quarta . terza-più-di-maggiore)
                              (quarta-minima . quarta-minima)))
    (sesta-maggiore . ((sesta-più-di-minore . diesis-minore)
                       (sesta-minore . semitono-minore)
                       (sesta-minima . semitono-maggiore)
                       (quinta-propinqua . tono-minore)
                       (quinta . tono)
                       (quinta-imperfetta-propinqua . tono-maggiore)
                       (quinta-imperfetta . terza-minima)
                       (tritono . terza-minore)
                       (quarta-propinqua . terza-più-di-minore)
                       (quarta . terza-maggiore)
                       (quarta-minima . terza-più-di-maggiore)))
    (sesta-più-di-minore . ((sesta-minore . diesis-minore)
                            (sesta-minima . semitono-minore)
                            (quinta-propinqua . semitono-maggiore)
                            (quinta . tono-minore)
                            (quinta-imperfetta-propinqua . tono)
                            (quinta-imperfetta . tono-maggiore)
                            (tritono . terza-minima)
                            (quarta-propinqua . terza-minore)
                            (quarta . terza-più-di-minore)
                            (quarta-minima . terza-maggiore)
                            (terza-più-di-maggiore . terza-più-di-maggiore)))
    (sesta-minore . ((sesta-minima . diesis-minore)
                     (quinta-propinqua . semitono-minore)
                     (quinta . semitono-maggiore)
                     (quinta-imperfetta-propinqua . tono-minore)
                     (quinta-imperfetta . tono)
                     (tritono . tono-maggiore)
                     (quarta-propinqua . terza-minima)
                     (quarta . terza-minore)
                     (quarta-minima . terza-più-di-minore)
                     (terza-più-di-maggiore . terza-maggiore)
                     (terza-maggiore . terza-più-di-maggiore)))
    (sesta-minima . ((quinta-propinqua . diesis-minore)
                     (quinta . semitono-maggiore)
                     (quinta-imperfetta-propinqua . tono-minore)
                     (quinta-imperfetta . tono)
                     (tritono . tono-maggiore)
                     (quarta-propinqua . terza-minima)
                     (quarta . terza-più-di-minore)
                     (quarta-minima . terza-minore)
                     (terza-più-di-maggiore . terza-più-di-minore)
                     (terza-maggiore . terza-maggiore)))
    (quinta-propinqua . ((quinta . diesis-minore)
                         (quinta-imperfetta-propinqua . semitono-minore)
                         (quinta-imperfetta . semitono-maggiore)
                         (tritono . tono-minore)
                         (quarta-propinqua . tono)
                         (quarta . tono-maggiore)
                         (quarta-minima . terza-minima)
                         (terza-più-di-maggiore . terza-minore)
                         (terza-maggiore . terza-più-di-minore)))
    (quinta . ((quinta-imperfetta-propinqua . diesis-minore)
               (quinta-imperfetta . semitono-minore)
               (tritono . semitono-maggiore)
               (quarta-propinqua . tono-minore)
               (quarta . tono)
               (quarta-minima . tono-maggiore)
               (terza-più-di-maggiore . terza-minima)
               (terza-maggiore . terza-minore)
               (terza-più-di-minore . terza-più-di-minore)))
    (quinta-imperfetta-propinqua . ((quinta-imperfetta . diesis-minore)
                                    (tritono . semitono-minore)
                                    (quarta-propinqua . semitono-maggiore)
                                    (quarta . tono-minore)
                                    (quarta-minima . tono)
                                    (terza-più-di-maggiore . tono-maggiore)
                                    (terza-maggiore . terza-minima)
                                    (terza-più-di-minore . terza-minore)))
    (quinta-imperfetta . ((tritono . diesis-minore)
                          (quarta-propinqua . semitono-minore)
                          (quarta . semitono-maggiore)
                          (quarta-minima . tono-minore)
                          (terza-più-di-maggiore . tono)
                          (terza-maggiore . tono-maggiore)
                          (terza-più-di-minore . terza-minima)
                          (terza-minore . terza-minore)))
    (tritono . ((quarta-propinqua . diesis-minore)
                (quarta . semitono-minore)
                (quarta-minima . semitono-maggiore)
                (terza-più-di-maggiore . tono-minore)
                (terza-maggiore . tono)
                (terza-più-di-minore . tono-maggiore)
                (terza-minore . terza-minima)))
    (quarta-propinqua . ((quarta . diesis-minore)
                         (quarta-minima . semitono-minore)
                         (terza-più-di-maggiore . semitono-maggiore)
                         (terza-maggiore . tono-minore)
                         (terza-più-di-minore . tono)
                         (terza-minore . tono-maggiore)
                         (terza-minima . terza-minima)))
    (quarta . ((quarta-minima . diesis-minore)
               (terza-più-di-maggiore . semitono-minore)
               (terza-maggiore . semitono-maggiore)
               (terza-più-di-minore . tono-minore)
               (terza-minore . tono)
               (terza-minima . tono-maggiore)))
    (quarta-minima . ((terza-più-di-maggiore . diesis-minore)
                      (terza-maggiore . semitono-minore)
                      (terza-più-di-minore . semitono-maggiore)
                      (terza-minore . tono-minore)
                      (terza-minima . tono)
                      (tono-maggiore . tono-maggiore)))
    (terza-più-di-maggiore . ((terza-maggiore . diesis-minore)
                              (terza-più-di-minore . semitono-minore)
                              (terza-minore . semitono-maggiore)
                              (terza-minima . tono-minore)
                              (tono-maggiore . tono)))
    (terza-maggiore . ((terza-più-di-minore . diesis-minore)
                       (terza-minore . semitono-minore)
                       (terza-minima . semitono-maggiore)
                       (tono-maggiore . tono-minore)
                       (tono . tono)))
    (terza-più-di-minore . ((terza-minore . diesis-minore)
                            (terza-minima . semitono-minore)
                            (tono-maggiore . semitono-maggiore)
                            (tono . tono-minore)))
    (terza-minore . ((terza-minima . diesis-minore)
                     (tono-maggiore . semitono-minore)
                     (tono . semitono-maggiore)
                     (tono-minore . tono-minore)))
    (terza-minima . ((tono-maggiore . diesis-minore)
                     (tono . semitono-minore)
                     (tono-minore . semitono-maggiore)))
    (tono-maggiore . ((tono . diesis-minore)
                      (tono-minore . semitono-minore)
                      (semitono-maggiore . semitono-maggiore)))
    (tono . ((tono-minore . diesis-minore)
             (semitono-maggiore . semitono-minore)))
    (tono-minore . ((semitono-maggiore . diesis-minore)
                    (semitono-minore . semitono-minore)))
    (semitono-maggiore . ((diesis-maggiore . diesis-minore)))
    (semitono-minore . ((diesis-minore . diesis-minore)))
    ;;(diesis-minore . ((comma . comma)))
    )
  "All melodic intervals according to Vicentino's \"Libro primo della prattica musicale\". There is a
conceptual distinction between the \"diesis enarmonico maggiore\" and the \"semitono minore\". No
\"propinquissimo\"-intervals are included. The \"comma\" is defined as half the size of the \"diesis
minore\", but not included in the interval tree. For the \"terza manca di minore\", the alternative
name \"terza minima\" is used. \"quarta minima\" is defined, although never mentioned by Vicentino.")
